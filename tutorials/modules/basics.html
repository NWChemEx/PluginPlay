<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Basics of Writing a Module &mdash; PluginPlay 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=8d563738"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="../../_static/tabs.js?v=3030b3cb"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Templated Modules" href="templated.html" />
    <link rel="prev" title="Module Development" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/full_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../background/index.html">PluginPlay Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../features.html">List of PluginPlay Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installing PluginPlay</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">PluginPlay Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Module Development</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Basics of Writing a Module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#declaring-the-module">Declaring the Module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#defining-the-module">Defining the Module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="templated.html">Templated Modules</a></li>
<li class="toctree-l3"><a class="reference internal" href="iterative.html">Iterative Modules</a></li>
<li class="toctree-l3"><a class="reference internal" href="advanced.html">Advanced Module Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="design.html">Designing a Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../property_types/index.html">Property Type Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/index.html">Module Collections</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faqs.html">PluginPlay Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bibliography/bibliography.html">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">APIs:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://nwchemex.github.io/PluginPlay/pluginplay_cxx_api/index.html">C++ API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PluginPlay</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">PluginPlay Tutorials</a></li>
          <li class="breadcrumb-item"><a href="index.html">Module Development</a></li>
      <li class="breadcrumb-item active">Basics of Writing a Module</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/tutorials/modules/basics.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="basics-of-writing-a-module">
<h1>Basics of Writing a Module<a class="headerlink" href="#basics-of-writing-a-module" title="Link to this heading"></a></h1>
<p>This page is intended to walk you through the basics of writing a module. Here
we focus purely on writing the module, not designing it. Because of how
PluginPlay works designing a module can sometimes be non-trivial; tips for
designing a module can be found in <a class="reference internal" href="design.html#module-designing"><span class="std std-ref">Designing a Module</span></a>. This page assumes we are
writing a module which computes the electric field, <span class="math notranslate nohighlight">\(\vec{E}\left(\vec{r}\right)\)</span> of a series of
point charges as detailed in <a class="reference internal" href="index.html#module-development"><span class="std std-ref">Module Development</span></a>.</p>
<section id="declaring-the-module">
<h2>Declaring the Module<a class="headerlink" href="#declaring-the-module" title="Link to this heading"></a></h2>
<p>In PluginPlay modules are implemented by inheriting from the <code class="docutils literal notranslate"><span class="pre">ModuleBase</span></code>
class and then implementing a constructor and a <code class="docutils literal notranslate"><span class="pre">run_</span></code> member. The declaration
amounts to a large amount of boilerplate so PluginPlay provides a macro
<code class="docutils literal notranslate"><span class="pre">DECLARE_MODULE(T)</span></code> which will declare a class <code class="docutils literal notranslate"><span class="pre">T</span></code> satisfying the required
API. Since it will be used as the name of the class, <code class="docutils literal notranslate"><span class="pre">T</span></code> must be a valid C
identifier.</p>
<p>Generally speaking modules of the same property type differ by the algorithm
used to compute the property. It thus makes sense to somehow include the
algorithm in the module’s name. For the purposes of our electric field module we
will compute the electric field via Coulomb’s Law so we choose to name our
module <code class="docutils literal notranslate"><span class="pre">CoulombsLaw</span></code> and we store the declaration in a file <code class="docutils literal notranslate"><span class="pre">modules.hpp</span></code>.
The relevant lines are:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma once</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pluginplay/pluginplay.hpp&gt;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">pluginplay_examples</span><span class="w"> </span><span class="p">{</span>

<span class="n">DECLARE_MODULE</span><span class="p">(</span><span class="n">CoulombsLaw</span><span class="p">);</span>

<span class="p">}</span><span class="w"> </span><span class="c1">// namespace pluginplay_examples</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Most libraries include more than one module, and given that declaring a
module requires a single line, it is not uncommon to declare multiple modules
in a single header file.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Declaring a module is not required if the module is written in Python.</p>
</div>
</section>
<section id="defining-the-module">
<h2>Defining the Module<a class="headerlink" href="#defining-the-module" title="Link to this heading"></a></h2>
<p>The definition of our <code class="docutils literal notranslate"><span class="pre">CoulombsLaw</span></code> module goes in a source file. Defining the
module amounts to implementing two functions: the default constructor and the
<code class="docutils literal notranslate"><span class="pre">run_</span></code> member function. The constructor is where all the set-up for your
module occurs; it is also where you can set meta-data associated with your
module. The <code class="docutils literal notranslate"><span class="pre">run_</span></code> member function is where your module does the work.</p>
<section id="defining-the-constructor">
<h3>Defining the Constructor<a class="headerlink" href="#defining-the-constructor" title="Link to this heading"></a></h3>
<p>PluginPlay provides the macro <code class="docutils literal notranslate"><span class="pre">MODULE_CTOR(T)</span></code>, where <code class="docutils literal notranslate"><span class="pre">T</span></code> is the name of the
module to aid in defining the module’s constructor. At a minimum the constructor
must set the property type(s) that the module satisfies. It is also a good idea
to provide a short description about the algorithm implemented in the module.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>The property type will be needed in a few places so it is a good idea to set
a typedef, this way if you need to change the property type for any reason
you only need to change it in the typedef.</p>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>The raw string literal introduced in C++11 denoted by
<code class="docutils literal notranslate"><span class="pre">auto</span> <span class="pre">str</span> <span class="pre">=</span> <span class="pre">R&quot;(...)&quot;;</span></code> is a great way to write a lengthy description
without having to use escapes or other workarounds for line endings.</p>
</div>
<p>For our <code class="docutils literal notranslate"><span class="pre">CoulombsLaw</span></code> module a basic constructor looks like:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">C++</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">Python</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">module_desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sa">R</span><span class="s">&quot;</span><span class="dl">(</span>
<span class="s">Electric Field From Coulomb&#39;s Law</span>
<span class="s">---------------------------------</span>

<span class="s">This module computes the electric field of a series of point charges using</span>
<span class="s">Coulomb&#39;s law according to:</span>

<span class="s">.. math::</span>

<span class="s">   \vec{E}(\vec{r}) = \sum_{i=1}^N</span>
<span class="s">                      \frac{q_i \hat{r}_i}{||\vec{r} - \vec{r}_i||^2}</span>
<span class="dl">)</span><span class="s">&quot;</span><span class="p">;</span>

<span class="n">MODULE_CTOR</span><span class="p">(</span><span class="n">CoulombsLaw</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">description</span><span class="p">(</span><span class="n">module_desc</span><span class="p">);</span>
<span class="w">    </span><span class="n">satisfies_property_type</span><span class="o">&lt;</span><span class="n">ElectricField</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pp</span><span class="o">.</span><span class="n">ModuleBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">(</span><span class="s2">&quot;Electric Field From Coulomb&#39;s Law&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">satisfies_property_type</span><span class="p">(</span><span class="n">ppe</span><span class="o">.</span><span class="n">ElectricField</span><span class="p">())</span>
</pre></div>
</div>
</div></div>
<p>One particularly nice feature of PluginPlay is that it can autogenerate
restructured text documentation for modules by scraping the meta-data and fields
of the module. The description we provided serves as a preface to the resulting
page. Some of the other meta-data that module developers can set in the
constructor includes: a list of citations, the author of the module, and the
version. A full list of meta-data is available (TODO: Add link).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>PluginPlay automatically documents input parameters and submodules so there
is no need to include these in your description.</p>
</div>
<p>For some modules, inputs that are not defined by the property type(s)
may be needed. Additional inputs can be specified in the constructor with the
<code class="docutils literal notranslate"><span class="pre">add_inputs</span></code> method. A similar option for added results exist, though it is
less common. Additional inputs have to be set before the module is run, either
with a default value or by calling the <code class="docutils literal notranslate"><span class="pre">change_input</span></code> method. Here are
examples for adding a screening threshold to our <code class="docutils literal notranslate"><span class="pre">ScreenedCoulombsLaw</span></code> module:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">C++</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">Python</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">MODULE_CTOR</span><span class="p">(</span><span class="n">ScreenedCoulombsLaw</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">description</span><span class="p">(</span><span class="n">module_desc</span><span class="p">);</span>
<span class="w">    </span><span class="n">satisfies_property_type</span><span class="o">&lt;</span><span class="n">prop_type</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="n">add_input</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;threshold&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="n">set_description</span><span class="p">(</span><span class="s">&quot;maximum ||r-r_i|| for contributing to electric field&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="n">set_default</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pp</span><span class="o">.</span><span class="n">ModuleBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">(</span><span class="s2">&quot;Screened Electric Field From Coulomb&#39;s Law&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">satisfies_property_type</span><span class="p">(</span><span class="n">ppe</span><span class="o">.</span><span class="n">ElectricField</span><span class="p">())</span>
</pre></div>
</div>
</div></div>
</section>
<section id="defining-the-run-member">
<h3>Defining the Run Member<a class="headerlink" href="#defining-the-run-member" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">run_</span></code> member of the module takes a set of inputs and a set of submodules,
and returns the property (or properties). Like the module constructor,
PluginPlay provides the macro <code class="docutils literal notranslate"><span class="pre">MODULE_RUN(T)</span></code>, where <code class="docutils literal notranslate"><span class="pre">T</span></code> is the name of the
module to aid in defining the module’s <code class="docutils literal notranslate"><span class="pre">run_</span></code> member function. By convention
(and hidden in the definition of the macro) the names of the two arguments are:
<code class="docutils literal notranslate"><span class="pre">inputs</span></code> and <code class="docutils literal notranslate"><span class="pre">submods</span></code>. Presently we will ignore the <code class="docutils literal notranslate"><span class="pre">submods</span></code> argument.</p>
<p>For defining our <code class="docutils literal notranslate"><span class="pre">CoulombsLaw::run_</span></code> member the relevant PluginPlay bits of
code are:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0">C++</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1">Python</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">MODULE_RUN</span><span class="p">(</span><span class="n">CoulombsLaw</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">charges</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ElectricField</span><span class="o">::</span><span class="n">unwrap_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// This will be the value of the electric field</span>
<span class="w">    </span><span class="n">Point</span><span class="w"> </span><span class="n">E</span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">};</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">results</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ElectricField</span><span class="o">::</span><span class="n">wrap_results</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">run_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">submods</span><span class="p">):</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">ppe</span><span class="o">.</span><span class="n">ElectricField</span><span class="p">()</span>
        <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">charges</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">unwrap_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pt</span><span class="o">.</span><span class="n">wrap_results</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>The inputs to a module are type-erased. Getting them back in a usable typed form
can be done automatically via template meta-programming. The details of this
process are beyond our present scope; for now know that every property type
defines a static function <code class="docutils literal notranslate"><span class="pre">unwrap_inputs</span></code> which takes the type-erased inputs
and returns an <code class="docutils literal notranslate"><span class="pre">std::tuple</span></code> with the typed inputs (in the above example we
use C++17’s structured bindings to automatically unpack the tuple). In a similar
vein the results of every module are also type-erased and every property type
defines a static function <code class="docutils literal notranslate"><span class="pre">wrap_results</span></code> which takes the typed results and
returns a result map with the type-erased results.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a module has additional inputs beyond those specified by the property
type, they will have to be specifically unpacked from the <code class="docutils literal notranslate"><span class="pre">inputs</span></code>. In the
case of the <code class="docutils literal notranslate"><span class="pre">ScreenedCoulombsLaw</span></code> module, the screening threshold is
acquired as:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-3-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-3-3-0" name="3-0" role="tab" tabindex="0">C++</button><button aria-controls="panel-3-3-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-1" name="3-1" role="tab" tabindex="-1">Python</button></div><div aria-labelledby="tab-3-3-0" class="sphinx-tabs-panel" id="panel-3-3-0" name="3-0" role="tabpanel" tabindex="0"><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">MODULE_RUN</span><span class="p">(</span><span class="n">ScreenedCoulombsLaw</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">charges</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prop_type</span><span class="o">::</span><span class="n">unwrap_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">);</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">thresh</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">inputs</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="s">&quot;threshold&quot;</span><span class="p">).</span><span class="n">value</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">();</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-3-3-1" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-1" name="3-1" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
    <span class="k">def</span> <span class="nf">run_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">submods</span><span class="p">):</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">ppe</span><span class="o">.</span><span class="n">ElectricField</span><span class="p">()</span>
        <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">charges</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">unwrap_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</div>
<p>The full definition of the <code class="docutils literal notranslate"><span class="pre">run_</span></code> member for the <code class="docutils literal notranslate"><span class="pre">CoulombsLaw</span></code> module
(including the source code for computing the electric field) is:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-4-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-4-4-0" name="4-0" role="tab" tabindex="0">C++</button><button aria-controls="panel-4-4-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-1" name="4-1" role="tab" tabindex="-1">Python</button></div><div aria-labelledby="tab-4-4-0" class="sphinx-tabs-panel" id="panel-4-4-0" name="4-0" role="tabpanel" tabindex="0"><div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">MODULE_RUN</span><span class="p">(</span><span class="n">CoulombsLaw</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">charges</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ElectricField</span><span class="o">::</span><span class="n">unwrap_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// This will be the value of the electric field</span>
<span class="w">    </span><span class="n">Point</span><span class="w"> </span><span class="n">E</span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">};</span>

<span class="w">    </span><span class="c1">// This loop fills in E</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">charge</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">charges</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">q</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">charge</span><span class="p">.</span><span class="n">m_charge</span><span class="p">;</span>
<span class="w">        </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">ri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">charge</span><span class="p">.</span><span class="n">m_r</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Magnitude of r_i</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">ri2</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">inner_product</span><span class="p">(</span><span class="n">ri</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">ri</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">ri</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">mag_ri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ri2</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ||r - r_i||**2</span>
<span class="w">        </span><span class="n">Point</span><span class="w"> </span><span class="nf">rij</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="n">rij</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">charge</span><span class="p">.</span><span class="n">m_r</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">rij2</span><span class="w"> </span><span class="o">=</span>
<span class="w">          </span><span class="n">std</span><span class="o">::</span><span class="n">inner_product</span><span class="p">(</span><span class="n">rij</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">rij</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">rij</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>

<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">mag_ri</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rij2</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">results</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ElectricField</span><span class="o">::</span><span class="n">wrap_results</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-4-1" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-1" name="4-1" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">run_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">submods</span><span class="p">):</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">ppe</span><span class="o">.</span><span class="n">ElectricField</span><span class="p">()</span>
        <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">charges</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">unwrap_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">charge</span> <span class="ow">in</span> <span class="n">charges</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">charge</span><span class="o">.</span><span class="n">m_charge</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">charge</span><span class="o">.</span><span class="n">m_r</span>
            <span class="n">ri2</span> <span class="o">=</span> <span class="n">ri</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ri</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ri</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">mag_ri</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">ri2</span><span class="p">)</span>
            <span class="n">rij</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">rij</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">charge</span><span class="o">.</span><span class="n">m_r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">rij2</span> <span class="o">=</span> <span class="n">rij</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">rij</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">rij</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">mag_ri</span> <span class="o">*</span> <span class="n">rij2</span><span class="p">))</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pt</span><span class="o">.</span><span class="n">wrap_results</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">E</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
</section>
<section id="submodules">
<h2>Submodules<a class="headerlink" href="#submodules" title="Link to this heading"></a></h2>
<p>Coulomb’s Law is pretty simple. Most simulation techniques are much more
complicated than that and involve an intricate interplay of many different
properties.</p>
<p>As an example say we are writing a module which computes the force of a moving
charged particle at a position <span class="math notranslate nohighlight">\(\vec{r}\)</span>, <span class="math notranslate nohighlight">\(\vec{F}\left(\vec{r}\right)\)</span>. Assuming the particle
has a mass <span class="math notranslate nohighlight">\(m\)</span>, its acceleration at <span class="math notranslate nohighlight">\(\vec{r}\)</span> is given by <span class="math notranslate nohighlight">\(\vec{a}\left(\vec{r}\right)\)</span>,
and that it has a charge <span class="math notranslate nohighlight">\(q\)</span>, the <span class="math notranslate nohighlight">\(\vec{F}\left(\vec{r}\right)\)</span> is given by:</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\newcommand{\force}{\vec{F}\left(\vec{r}\right)}
\newcommand{\acceleration}{\vec{a}\left(\vec{r}\right)}
\newcommand{\efield}{\vec{E}\left(\vec{r}\right)}\\\force = m\acceleration + q\efield\end{aligned}\end{align} \]</div>
<p>The important point for this tutorial is that <span class="math notranslate nohighlight">\(F\left(\vec{r}\right)\)</span> can
be written in terms of the electric field, <span class="math notranslate nohighlight">\(\vec{E}\left(\vec{r}\right)\)</span>. To capitialize on all the
innovations in computing electric fields, we decide to write our force module in
terms of an electric field submodule.</p>
<p>Submodules change the class’s definition. In the constructor we now need to
declare that our module uses a submodule and that the submodule must satisfy the
property type <cite>ElectricField</cite>. This looks like:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">MODULE_CTOR</span><span class="p">(</span><span class="n">ClassicalForce</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">description</span><span class="p">(</span><span class="n">module_desc</span><span class="p">);</span>
<span class="w">    </span><span class="n">satisfies_property_type</span><span class="o">&lt;</span><span class="n">force_type</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">    </span><span class="n">add_submodule</span><span class="o">&lt;</span><span class="n">efield_type</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;electric field&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="n">set_description</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;Used to compute the electric field of the point charges&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>PluginPlay also requires that we specify a tag (we choose the tag
<code class="docutils literal notranslate"><span class="pre">&quot;electric</span> <span class="pre">field&quot;</span></code>). The tag ensures that the module can specify and
distinguish between multiple submodules of the same type. When appropriately
named, the tag also aids in readability of the code. The <code class="docutils literal notranslate"><span class="pre">run_</span></code> function for
our module looks like:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">MODULE_RUN</span><span class="p">(</span><span class="n">ClassicalForce</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">charges</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">force_type</span><span class="o">::</span><span class="n">unwrap_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// This will be the value of the force</span>
<span class="w">    </span><span class="n">Point</span><span class="w"> </span><span class="n">F</span><span class="p">{</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">};</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">submods</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="s">&quot;electric field&quot;</span><span class="p">).</span><span class="n">run_as</span><span class="o">&lt;</span><span class="n">efield_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">m_r</span><span class="p">,</span><span class="w"> </span><span class="n">charges</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">m_charge</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">rv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">results</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">force_type</span><span class="o">::</span><span class="n">wrap_results</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Of note is the line:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">submods</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="s">&quot;electric field&quot;</span><span class="p">).</span><span class="n">run_as</span><span class="o">&lt;</span><span class="n">efield_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">m_r</span><span class="p">,</span><span class="w"> </span><span class="n">charges</span><span class="p">);</span>
</pre></div>
</div>
<p>which says we are running the submodule tagged with <code class="docutils literal notranslate"><span class="pre">&quot;electric</span> <span class="pre">field&quot;</span></code> as an
<code class="docutils literal notranslate"><span class="pre">efield_type</span></code>. We provide the submodule with the point charge’s location and
the list of point charges defining the electric field.</p>
<p>Submodules are integral to PluginPlay so it is worth noting:</p>
<ul class="simple">
<li><p>By using submodules we establish data dependencies (<em>i.e.</em> here we stated we
need an electric field, we don’t care how it’s computed)</p></li>
<li><p>If tomorrow someone writes a new electric field module, it can immediately be
used with our force module without modifying the force module.</p></li>
<li><p>The submodule that is called can be changed at runtime by the user and our
module doesn’t have to maintain the logic to do so (<em>i.e.</em> our force module
doesn’t need to maintain a list of all possible submodules and switch between
them).</p></li>
<li><p>If the calculation crashes after computing the electric field, but before the
module completes (pretty unlikely given how few operations remain) memoization
will avoid the need to recompute the electric field when the calculation is
restarted. The module does not have to maintain separate checkpoint/restart
logic!!!!!</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Module Development" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="templated.html" class="btn btn-neutral float-right" title="Templated Modules" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, NWChemEx Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>